<!DOCTYPE html>
<!--
Copyright 2019 Google LLC

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    https://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<html lang="en">
  <head>
    <title>pifuhd</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

    <!-- The following libraries and polyfills are recommended to maximize browser support -->
    <!-- NOTE: you must adjust the paths as appropriate for your project -->

    <!-- ðŸš¨ REQUIRED: Web Components polyfill to support Edge and Firefox < 63 -->
    <script src="https://unpkg.com/@webcomponents/webcomponentsjs@2.1.3/webcomponents-loader.js"></script>

    <!-- ðŸ’ OPTIONAL: Intersection Observer polyfill for better performance in Safari and IE11 -->
    <script src="https://unpkg.com/intersection-observer@0.5.1/intersection-observer.js"></script>

    <!-- ðŸ’ OPTIONAL: Resize Observer polyfill improves resize behavior in non-Chrome browsers -->
    <script src="https://unpkg.com/resize-observer-polyfill@1.5.1/dist/ResizeObserver.js"></script>

<body>
  <div class = "container">
    <div class="jumbotron mt-3">

        <h1>PIFuHD</h1>
        <h3>It creates 3D objects for picture of the human body. Try it!</h3>
        <A>Git Hub repository : </A> <A href="https://github.com/psi1104/pifuhd"> PIFuHD repo</A>

        <hr class="solid">

        <h2>Usage</h2>
        <div id="usage">
            <p>1. Please name the image file in English or in numbers.</p>
            <p>2. Please upload the image file of a person alone you want to create 3D object.</p>
            <p> Tip.For better results, the PIfUHD requires a full-body image standing alone, 500 * 500 or more size.</p>
            <p>3. Please press the Run button and wait for about 20 seconds.</p>
        </div>
        <h2>Upload </h2>
        <div id="sampleBox" style="margin-bottom: 5px;">
            <p style="display:inline">Sample : </p>
            <a href="https://raw.githubusercontent.com/psi1104/pifuhd/master/sample_images/sample1.jpg" target="blank">Sample Image1</a>
            &nbsp;&nbsp;&nbsp;
            <a href="https://raw.githubusercontent.com/psi1104/pifuhd/master/sample_images/sample2.jpg" target="blank">Sample Image2</a>
        </div>
        <div id = 'inputImage'>
            <label for="source"> Upload image : </label>
            <input type = 'file' id = 'source' style="margin-right: 10px; margin-bottom: 10px;">
            <p>* Please upload an image file that is less than 1MB.</p>
            <button id = "submit" type='submit' onclick="this.disabled=true;" class="btn btn-primary btn-lg" style="margin-left: auto;"> Run </button>
        </div>

        <div id ='resultBox' style="margin-left: auto; margin-right: auto;">
            <p id='errorbox'></p>
            <img id='resultImage' src="{{url_for('static', filename='test.png')}}"  style="width: 300px; height: 300px; max-width: 100%; max-height: 100%;">

            <model-viewer id='resultModel'
                          src="{{ url_for('static', filename='sample.gltf')}}"
                          auto-rotate camera-controls
                          alt="A 3D model of an astronaut"
                          style="height: 300px">
            </model-viewer>
            <a href="" id="down" download>
                <button id = "download" type='button' disabled='true' class="fa fa-download" style="margin-left: auto;"> Download glb file </button>
            </a>
            <p>* Please write .glb at the end of the download file name.</p>
        </div>

        <script>
            document.getElementById("submit").onclick = () => {
                document.getElementById("submit").disabled = true;
                document.getElementById("errorbox").innerHTML = "";
                const formData = new FormData();
                try{
                    if (document.getElementById('source').files[0] == undefined){
                        throw Error("Please upload image file");
                    }
                }catch (e) {
                    document.getElementById("errorbox").innerHTML = e;
                    document.getElementById("submit").disabled = false;
                    return;
                }

                const source = document.getElementById('source').files[0]

                document.getElementById("resultImage").src = URL.createObjectURL(source);
                document.getElementById("resultModel").setAttribute('src', "");
                document.getElementById("resultModel").removeAttribute('src');
                document.getElementById("download").disabled = true;

                formData.append('source', source)

                fetch(
                    '/predict',
                    {
                        method: 'POST',
                        body: formData,
                    }
                )
                .then(async response => {
                    if ( response.status == 200){
                        return response
                    }
                    else if( response.status == 413) {
                        throw Error("This image file is larger than 1MB.")
                    }
                    else if( response.status == 503) {
                        throw Error("Too Many Requests.")
                    }
                    else{
                        throw Error((await response.clone().json()).message)
                    }
                })
                .then(response => response.blob())
                .then(blob => URL.createObjectURL(blob))
                .then(imageURL => {
                    document.getElementById("resultModel").src = imageURL;
                    document.getElementById("down").setAttribute('href', imageURL);
                    document.getElementById("errorbox").innerHTML = "";
                    document.getElementById("submit").disabled = false;
                    document.getElementById("download").disabled = false;
                })
                .catch(e =>{
                    document.getElementById("errorbox").innerHTML = e;
                    document.getElementById("submit").disabled = false;
                })
            }
        </script>
      </div>
    </div>

  <script type="module"
    src="{{ url_for('static', filename='node_modules/@google/model-viewer/dist/model-viewer.min.js')}}"></script>

  <script nomodule
    src="{{ url_for('static', filename='node_modules/@google/model-viewer/dist/model-viewer-legacy.js')}}"></script>

</body>
</html>
